<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mat Harvey — Portfolio World</title>
    <style>
        :root{--hud:rgba(10,18,12,.72);--hb:rgba(120,180,100,.22);--t:#e8f0e4;--s:#9ab892;--a:#6ec86e;--a2:#f0c060;--w:#5cc0b8}
        *{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;font-family:"Segoe UI",system-ui,sans-serif;color:var(--t);background:#1a2818}
        #app{width:100%;height:100%;position:relative}canvas{display:block;width:100%;height:100%}
        #loading{position:fixed;inset:0;background:linear-gradient(135deg,#1a2818,#0e180c);display:flex;align-items:center;justify-content:center;z-index:999;transition:opacity .8s}
        #loading h1{font-size:2rem;color:#8fcc6a;letter-spacing:.14em;text-transform:uppercase;font-weight:700}#loading p{margin-top:10px;color:#6a9a5c;font-size:.95rem}
        .panel{position:absolute;backdrop-filter:blur(10px);border:1px solid var(--hb);background:var(--hud);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.3)}
        .hud{top:14px;left:14px;width:min(360px,calc(100vw - 28px));padding:12px 14px;display:grid;gap:6px}.hud-title{font-size:.8rem;text-transform:uppercase;letter-spacing:.1em;color:var(--a);font-weight:700}
        .hud-row{display:flex;justify-content:space-between;gap:12px;font-size:.86rem}.hud-row .v{color:var(--a2);font-weight:600;text-align:right}.hint{color:var(--s);font-size:.76rem;line-height:1.4}
        .side-panel{top:14px;right:14px;width:min(300px,calc(100vw - 28px));padding:12px;display:grid;gap:7px;max-height:50vh;overflow-y:auto}
        .section-label{font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--s)}
        .badge{font-size:.76rem;border:1px solid rgba(110,200,110,.18);border-radius:8px;color:var(--s);background:rgba(255,255,255,.02);padding:6px 9px;transition:all 180ms}.badge.on{color:#d4ffd4;border-color:rgba(110,200,110,.4);background:rgba(110,200,110,.08)}
        .prompt{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);min-width:min(440px,calc(100vw - 32px));text-align:center;padding:10px 14px;font-size:.86rem;border:1px solid rgba(110,200,110,.4);background:rgba(14,22,14,.88);border-radius:12px;opacity:0;pointer-events:none;transition:opacity .2s}.prompt.show{opacity:1}
        .toast{position:absolute;left:50%;top:78px;transform:translateX(-50%) translateY(-16px);border:1px solid rgba(110,200,110,.4);background:rgba(10,24,16,.92);color:#b8ffd0;border-radius:12px;padding:9px 14px;font-size:.82rem;opacity:0;pointer-events:none;transition:all .2s}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .links{position:absolute;left:14px;bottom:14px;display:flex;gap:8px}
        .btn{display:inline-flex;align-items:center;font-size:.76rem;color:#c8dcc4;border:1px solid rgba(200,220,196,.28);border-radius:8px;padding:6px 10px;text-decoration:none;background:rgba(14,22,14,.65);cursor:pointer}.btn:hover{border-color:var(--a);color:#fff}
        .dt{display:inline-block;font-size:.64rem;padding:2px 5px;border-radius:4px;margin-left:5px;font-weight:600}
        .dt-port{background:rgba(92,192,184,.15);color:var(--w)}.dt-sim{background:rgba(120,140,220,.15);color:#8898dd}.dt-tool{background:rgba(220,180,80,.15);color:var(--a2)}.dt-per{background:rgba(200,100,140,.15);color:#dd88aa}
        @media(max-width:860px){.side-panel{top:auto;bottom:60px;right:14px;max-height:32vh}.hud{width:min(280px,calc(100vw - 28px))}}
    </style>
</head>
<body>
<div id="app">
    <div id="loading"><div style="text-align:center"><h1>Portfolio World</h1><p>Building world… 45 projects across 4 districts</p></div></div>
    <div class="panel hud">
        <div class="hud-title">Mat Harvey — Portfolio World</div>
        <div class="hud-row"><span>District</span><span class="v" id="district">Town Center</span></div>
        <div class="hud-row"><span>Speed</span><span class="v" id="speed">0 km/h</span></div>
        <div class="hud-row"><span>Discovered</span><span class="v" id="visited">0 / 45</span></div>
        <div class="hud-row"><span>Season</span><span class="v" id="season">Spring</span></div>
        <div class="hint">W forward · S brake/reverse · A/D steer · Shift boost · E interact · M mute</div>
        <div class="hint">Park in the yellow bay to view a project.</div>
    </div>
    <div class="panel side-panel"><div class="section-label">Achievements</div><div id="badges"></div></div>
    <div class="prompt" id="prompt"></div><div class="toast" id="toast"></div>
    <div class="links"><a class="btn" href="index.html">← Classic Portfolio</a><button class="btn" id="mute-btn" type="button">Audio: ON</button></div>
</div>
<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.161.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/" } }
</script>
<script type="module">
import * as THREE from "three";
import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
import { OutputPass } from "three/addons/postprocessing/OutputPass.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

/* ====== SHADERS ====== */
const BOTW_VS=`
#ifdef USE_INSTANCING_COLOR
varying vec3 vIC;
#endif
varying vec3 vWN,vVD;varying float vFD;
void main(){
    #ifdef USE_INSTANCING_COLOR
    vIC=instanceColor;
    #endif
    vec4 wp;
    #ifdef USE_INSTANCING
    wp=modelMatrix*instanceMatrix*vec4(position,1.);vWN=normalize((modelMatrix*instanceMatrix*vec4(normal,0.)).xyz);
    #else
    wp=modelMatrix*vec4(position,1.);vWN=normalize((modelMatrix*vec4(normal,0.)).xyz);
    #endif
    vec4 mv=viewMatrix*wp;vVD=cameraPosition-wp.xyz;vFD=-mv.z;gl_Position=projectionMatrix*mv;}`;
const BOTW_FS=`
uniform vec3 uColor,uShadow,uSunDir,fogColor;uniform float fogNear,fogFar;
#ifdef USE_INSTANCING_COLOR
varying vec3 vIC;
#endif
varying vec3 vWN,vVD;varying float vFD;
void main(){vec3 base=uColor,sh=uShadow;
    #ifdef USE_INSTANCING_COLOR
    base*=vIC;sh*=vIC;
    #endif
    vec3 n=normalize(vWN);float NdL=dot(n,uSunDir)*.5+.5;NdL=floor(NdL*3.+.5)/3.;vec3 col=mix(sh,base,NdL);
    float rim=1.-max(dot(n,normalize(vVD)),0.);col+=vec3(1.,.95,.85)*smoothstep(.5,1.,rim)*.22;
    float ff=smoothstep(fogNear,fogFar,vFD);col=mix(col,fogColor,ff);gl_FragColor=vec4(col,1.);}`;
const WATER_VS=`uniform float uTime;varying vec2 vUv;varying float vFD;
void main(){vUv=uv;vec3 p=position;p.z-=sin(p.x*.15+uTime*1.5)*.2+cos(p.y*.12+uTime*1.2)*.15;
vec4 mv=modelViewMatrix*vec4(p,1.);vFD=-mv.z;gl_Position=projectionMatrix*mv;}`;
const WATER_FS=`uniform float uTime;uniform vec3 uShallow,uDeep,fogColor;uniform float fogNear,fogFar;
varying vec2 vUv;varying float vFD;
void main(){float w1=sin(vUv.x*28.+uTime*2.)*.5+.5;float w2=sin(vUv.y*20.+uTime*1.6+1.7)*.5+.5;
float w=w1*w2;vec3 col=mix(uDeep,uShallow,w*.35+.35);
col+=vec3(1.)*pow(w,6.)*.35+vec3(1.)*pow(max(sin(vUv.x*50.+uTime*3.)*sin(vUv.y*40.-uTime*2.5),0.),12.)*.2;
float ff=smoothstep(fogNear,fogFar,vFD);col=mix(col,fogColor,ff);gl_FragColor=vec4(col,.8);}`;

/* ====== MATCAP (car only) ====== */
function matcap(l,m,d){const s=256,cv=document.createElement("canvas");cv.width=s;cv.height=s;
const g=cv.getContext("2d"),gr=g.createRadialGradient(s*.38,s*.34,s*.05,s*.5,s*.52,s*.5);
gr.addColorStop(0,l);gr.addColorStop(.5,m);gr.addColorStop(1,d);g.fillStyle=gr;g.beginPath();g.arc(s/2,s/2,s/2,0,Math.PI*2);g.fill();
const t=new THREE.CanvasTexture(cv);t.colorSpace=THREE.SRGBColorSpace;return t;}
const MC={red:matcap("#ff9999","#cc2830","#601010"),dark:matcap("#606060","#1c1c20","#0a0a0a"),glass:matcap("#b0e8ff","#5898c8","#1c3860")};

/* ====== 45 PROJECTS ====== */
const DISTRICTS={
maritime:{label:"Port District",dtClass:"dt-port",color:"#3eaaa2",projects:[
    {t:"MarineStream Platform",u:"https://temp-msdt-for-review.onrender.com",g:"temp-msdt-for-review.gif"},
    {t:"Biofouling ID Guide",u:"https://mathew-harvey.github.io/BiofoulingIdGuide/",g:"BiofoulingIdGuide.gif"},
    {t:"Fouling Cost Calculator",u:"https://mathew-harvey.github.io/FoulingCostCalculator/",g:"FoulingCostCalculator.gif"},
    {t:"MarineStream Workspace",u:"https://MarineStream-Workspace.onrender.com",g:"MarineStream-Workspace.gif"},
    {t:"MarineStream Landing",u:"https://mathew-harvey.github.io/MarineStreamLandingPage/",g:"MarineStreamLandingPage.gif"},
    {t:"MarineStream App",u:"https://mathew-harvey.github.io/MarineStream/",g:"MarineStream.gif"},
    {t:"IWC Approval Portal",u:"https://mathew-harvey.github.io/IWC-Approval-Portal/",g:"IWC-Approval-Portal.gif"},
    {t:"BFMP Doc Generator",u:"https://mathew-harvey.github.io/Document-Generator/",g:"Document-Generator.gif"},
    {t:"BFMP Generator",u:"https://mathew-harvey.github.io/bfmpGenerator/",g:"bfmpGenerator.gif"},
    {t:"In-Water Hull Cleaning",u:"https://mathew-harvey.github.io/iwhc_franmarine/",g:"iwhc_franmarine.gif"},
    {t:"IWHC Manual Companion",u:"https://mathew-harvey.github.io/IWHCManualCompanionApp/",g:"IWHCManualCompanionApp.gif"},
    {t:"The Hull Truth",u:"https://mathew-harvey.github.io/TheHullTruth/",g:"TheHullTruth.gif"},
    {t:"Clean Hulls Clear Waters",u:"https://mathew-harvey.github.io/CleanHullsClearWaters/",g:"CleanHullsClearWaters.gif"},
]},
simulations:{label:"Science Park",dtClass:"dt-sim",color:"#6878cc",projects:[
    {t:"3D Ship Visualization",u:"https://mathew-harvey.github.io/3dShip/",g:"3dShip.gif"},
    {t:"Agentic Bubble Sort",u:"https://mathew-harvey.github.io/AgenticBubbleSort/",g:"AgenticBubbleSort.gif"},
    {t:"Ant Simulator",u:"https://mathew-harvey.github.io/AntSimulator/",g:"AntSimulator.gif"},
    {t:"Artificial Life",u:"https://mathew-harvey.github.io/Artificial-Life/",g:"Artificial-Life.gif"},
    {t:"Cancer Simulator",u:"https://mathew-harvey.github.io/CancerSimulator/",g:"CancerSimulator.gif"},
    {t:"Game of Life",u:"https://mathew-harvey.github.io/GameOfLife/",g:"GameOfLife.gif"},
    {t:"One Human Life",u:"https://mathew-harvey.github.io/One-Human-Life-React/",g:"One-Human-Life-React.gif"},
    {t:"Moltbook Throng",u:"https://mathew-harvey.github.io/Moltbook-Throng/",g:"Moltbook-Throng.gif"},
    {t:"Consciousness Framework",u:"https://mathew-harvey.github.io/A-New-Framework-for-Understanding-Consciousness/",g:"A-New-Framework-for-Understanding-Consciousness.gif"},
    {t:"Stages of Mind",u:"https://mathew-harvey.github.io/StagesOfMind/",g:"StagesOfMind.gif"},
]},
tools:{label:"Tech Hub",dtClass:"dt-tool",color:"#d0a030",projects:[
    {t:"Blurred Photos",u:"https://mathew-harvey.github.io/BlurredPhotos/",g:"BlurredPhotos.gif"},
    {t:"Image Compressor",u:"https://mathew-harvey.github.io/SimpleImageComression/",g:"SimpleImageComression.gif"},
    {t:"FormSync",u:"https://mathew-harvey.github.io/FormSync/",g:"FormSync.gif"},
    {t:"Net Connection Monitor",u:"https://mathew-harvey.github.io/NetConnectionMonitor/",g:"NetConnectionMonitor.gif"},
    {t:"VR Sim Racing Calc",u:"https://mathew-harvey.github.io/VrSimRacingCalc/",g:"VrSimRacingCalc.gif"},
    {t:"Web Disk Analyser",u:"https://mathew-harvey.github.io/WebDiskAnalyser/",g:"WebDiskAnalyser.gif"},
    {t:"Document Engine",u:"https://mathew-harvey.github.io/DocumentEngine/",g:"DocumentEngine.gif"},
]},
personal:{label:"Creative Village",dtClass:"dt-per",color:"#cc6088",projects:[
    {t:"FPV Track Planner",u:"https://mathew-harvey.github.io/FPVTrackPlanner/",g:"FPVTrackPlanner.gif"},
    {t:"Cat Translator",u:"https://mathew-harvey.github.io/CatTranslator/",g:"CatTranslator.gif"},
    {t:"Elodie Book One",u:"https://mathew-harvey.github.io/ElodieBook_One/",g:"ElodieBook_One.gif"},
    {t:"Elodie Book Two",u:"https://mathew-harvey.github.io/ElodieBook_Two/",g:"ElodieBook_Two.gif"},
    {t:"Extreme Limit Films",u:"https://mathew-harvey.github.io/ExtremeLimitFilms/",g:"ExtremeLimitFilms.gif"},
    {t:"Family Hiking",u:"https://mathew-harvey.github.io/FamilyHiking/",g:"FamilyHiking.gif"},
    {t:"Koi Runner",u:"https://mathew-harvey.github.io/KoiRunner/",g:"KoiRunner.gif"},
    {t:"Japan Itinerary",u:"https://mathew-harvey.github.io/JapanItinery/",g:"JapanItinery.gif"},
    {t:"WC MultiRotor Club",u:"https://mathew-harvey.github.io/WestCoastMultiRotorClub/",g:"WestCoastMultiRotorClub.gif"},
    {t:"Virtual Property Tour",u:"https://mathew-harvey.github.io/VirtualPropertyTour/",g:"VirtualPropertyTour.gif"},
    {t:"Portfolio 2025",u:"https://mathew-harvey.github.io/Mat-Portfolio-2025/",g:"Mat-Portfolio-2025.gif"},
    {t:"House Sitter Guide",u:"https://mathew-harvey.github.io/HouseSitter/",g:"HouseSitter.gif"},
    {t:"Skye Portfolio",u:"https://mathew-harvey.github.io/SkyePortfolio/",g:"SkyePortfolio.gif"},
    {t:"My Stuff",u:"https://mathew-harvey.github.io/MyStuffHere/",g:"MyStuffHere.gif"},
    {t:"Only Prints",u:"https://mathew-harvey.github.io/OnlyPrints/",g:"OnlyPrints.gif"},
]},
};
/* ====== COMPUTE BILLBOARD POSITIONS ====== */
/* Map layout:
   Ocean z<-65 → Port z=-48 to -32 (road z=-40)
   Tech Hub x=-75 to -35 (road x=-50) ← Town Center x=-20..+20 → Science Park x=35 to 75 (road x=50)
   Creative Village z=32 to 68 (road z=50)
   Main roads: x=0 N-S (16 wide), z=0 E-W (16 wide) — generous spacing, easy navigation */
const ALL_PROJECTS=[];
function addRow(arr,sx,sz,n,dx,dz,dist){arr.forEach((p,i)=>{if(i>=n)return;p.district=dist;p.wx=sx+i*dx;p.wz=sz+i*dz;ALL_PROJECTS.push(p);});}
// Port: E-W road at z=-40. Two rows: north (z=-33) & south (z=-47)
addRow(DISTRICTS.maritime.projects, -42,-33, 7, 14,0,"maritime");
addRow(DISTRICTS.maritime.projects.slice(7), -35,-47, 6, 14,0,"maritime");
// Science: N-S road at x=50. Two columns: east (x=60) & west (x=40)
addRow(DISTRICTS.simulations.projects, 60,-12, 5, 0,6,"simulations");
addRow(DISTRICTS.simulations.projects.slice(5), 40,-12, 5, 0,6,"simulations");
// Tech: N-S road at x=-50. Two columns: west (x=-60) & east (x=-40)
addRow(DISTRICTS.tools.projects, -60,-9, 4, 0,6,"tools");
addRow(DISTRICTS.tools.projects.slice(4), -40,-6, 3, 0,6,"tools");
// Creative: E-W road at z=50. Two rows: north (z=42) & south (z=58)
addRow(DISTRICTS.personal.projects, -42,42, 8, 12,0,"personal");
addRow(DISTRICTS.personal.projects.slice(8), -36,58, 7, 12,0,"personal");

/* Billboard rotation: face toward the nearest road */
function bbRot(p){
    if(p.district==="maritime"||p.district==="personal"){
        const rz=p.district==="maritime"?-40:50;
        return p.wz<rz?0:Math.PI; // face +z or -z toward road
    }else{
        const rx=p.district==="simulations"?50:-50;
        return p.wx>rx?-Math.PI/2:Math.PI/2; // face toward road
    }
}

const ACHIEVEMENTS=[
    {id:"ignite",title:"Ignition",desc:"Start the engine."},{id:"first",title:"Explorer",desc:"Visit your first project."},
    {id:"port",title:"Harbor Master",desc:"All maritime projects."},{id:"science",title:"Scientist",desc:"All simulation projects."},
    {id:"all",title:"Portfolio Complete",desc:"Visit every project."},{id:"speed",title:"JDM Spirit",desc:"Hit 120 km/h."},
    {id:"collector",title:"Treasure Hunter",desc:"Collect all orbs."},{id:"crash",title:"Demolition Derby",desc:"Send 10 objects flying."},
];

/* ====== STATE ====== */
const state={speed:0,maxSpeed:0,canInteract:null,visited:new Set(),achievements:new Set(),collectibles:new Set(),muted:false,seasonIndex:0,crashes:0};
const districtEl=document.getElementById("district"),speedEl=document.getElementById("speed"),visitedEl=document.getElementById("visited"),seasonEl=document.getElementById("season"),badgesEl=document.getElementById("badges"),promptEl=document.getElementById("prompt"),toastEl=document.getElementById("toast"),muteBtn=document.getElementById("mute-btn");
function showToast(t){toastEl.textContent=t;toastEl.classList.add("show");clearTimeout(showToast._t);showToast._t=setTimeout(()=>toastEl.classList.remove("show"),2200);}
function renderBadges(){badgesEl.innerHTML="";ACHIEVEMENTS.forEach(a=>{const e=document.createElement("div");e.className="badge"+(state.achievements.has(a.id)?" on":"");e.textContent=`${a.title} — ${a.desc}`;badgesEl.appendChild(e);});}
function unlock(id){if(state.achievements.has(id))return;state.achievements.add(id);renderBadges();const a=ACHIEVEMENTS.find(x=>x.id===id);if(a)showToast(`Achievement: ${a.title}`);}
renderBadges();
function getDistrict(x,z){if(z<-28)return"Port District";if(z>30)return"Creative Village";if(x>28)return"Science Park";if(x<-28)return"Tech Hub";return"Town Center";}

/* ====== SCENE ====== */
const scene=new THREE.Scene();scene.background=new THREE.Color("#78b8e6");scene.fog=new THREE.Fog("#a8d4ec",70,240);
const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,500);camera.position.set(0,10,18);
const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.outputColorSpace=THREE.SRGBColorSpace;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.15;
document.getElementById("app").appendChild(renderer.domElement);
const composer=new EffectComposer(renderer);composer.addPass(new RenderPass(scene,camera));
composer.addPass(new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),.28,.6,.84));composer.addPass(new OutputPass());
const hemi=new THREE.HemisphereLight("#b4d8f0","#5a8040",.9);scene.add(hemi);
const sun=new THREE.DirectionalLight("#fff0c8",1.1);sun.position.set(60,90,40);scene.add(sun);
const sunSphere=new THREE.Mesh(new THREE.SphereGeometry(5,16,16),new THREE.MeshBasicMaterial({color:"#ffe8a0"}));scene.add(sunSphere);

/* ====== MATERIALS ====== */
const sunDir=new THREE.Vector3(.5,.86,.3).normalize();
function botw(c,s,o){const cc=new THREE.Color(c),ss=s?new THREE.Color(s):cc.clone().multiplyScalar(.35);
return new THREE.ShaderMaterial({uniforms:{uColor:{value:cc},uShadow:{value:ss},uSunDir:{value:sunDir},fogColor:{value:scene.fog.color},fogNear:{value:70},fogFar:{value:240}},vertexShader:BOTW_VS,fragmentShader:BOTW_FS,side:(o&&o.side)||THREE.FrontSide});}
const waterMat=new THREE.ShaderMaterial({uniforms:{uTime:{value:0},uShallow:{value:new THREE.Color("#60d8c8")},uDeep:{value:new THREE.Color("#2888a0")},fogColor:{value:scene.fog.color},fogNear:{value:70},fogFar:{value:240}},vertexShader:WATER_VS,fragmentShader:WATER_FS,transparent:true,side:THREE.DoubleSide});

/* ====== TERRAIN ====== */
function hash2(a,b){const s=Math.sin(a*127.1+b*311.7)*43758.5453;return s-Math.floor(s);}
function ss(t){return t*t*(3-2*t);}function vn(x,z){const x0=Math.floor(x),z0=Math.floor(z),tx=ss(x-x0),tz=ss(z-z0);const a=hash2(x0,z0)+(hash2(x0+1,z0)-hash2(x0,z0))*tx;const b=hash2(x0,z0+1)+(hash2(x0+1,z0+1)-hash2(x0,z0+1))*tx;return a+(b-a)*tz;}
function fbm(x,z){let a=1,f=1,s=0,n=0;for(let i=0;i<5;i++){s+=vn(x*f,z*f)*a;n+=a;a*=.5;f*=2.1;}return s/n;}
const ROAD_SEGS=[
    {x1:0,z1:-68,x2:0,z2:75,hw:8},{x1:-88,z1:0,x2:88,z2:0,hw:8},        // Main boulevards 16 wide
    {x1:-55,z1:-40,x2:55,z2:-40,hw:6},{x1:-48,z1:50,x2:48,z2:50,hw:6},   // Port & Creative roads 12 wide
    {x1:-50,z1:-22,x2:-50,z2:22,hw:5},{x1:50,z1:-22,x2:50,z2:22,hw:5},   // Tech & Science entries 10 wide
    {x1:-38,z1:-40,x2:-38,z2:50,hw:4},{x1:38,z1:-40,x2:38,z2:50,hw:4},   // Side connectors 8 wide
];
function ptSeg(px,pz,x1,z1,x2,z2){const dx=x2-x1,dz=z2-z1,l2=dx*dx+dz*dz;if(l2<.01)return Math.hypot(px-x1,pz-z1);const t=Math.max(0,Math.min(1,((px-x1)*dx+(pz-z1)*dz)/l2));return Math.hypot(px-(x1+t*dx),pz-(z1+t*dz));}
function roadDist(x,z){let m=999;for(const r of ROAD_SEGS)m=Math.min(m,ptSeg(x,z,r.x1,r.z1,r.x2,r.z2)-r.hw);return m;}
const ROAD_Y=.25;
function terrainHeight(x,z){
    let h=(fbm(x*.02,z*.02)-.5)*9;h+=Math.sin(x*.04)*.6+Math.cos(z*.04)*.6;
    h*=Math.min(1,Math.max(.2,Math.hypot(x,z)/60));
    const rd=roadDist(x,z);if(rd<=0)h=ROAD_Y;else if(rd<8)h=ROAD_Y+(h-ROAD_Y)*ss(rd/8);
    if(z<-44){const p=Math.min(1,(-z-44)/22);h=h*(1-p*p)+(-1.2)*p*p;}return h;}
const WORLD=400,SEGS=190;
const tGeo=new THREE.PlaneGeometry(WORLD,WORLD,SEGS,SEGS);tGeo.rotateX(-Math.PI/2);
const tPos=tGeo.attributes.position,tColors=new Float32Array(tPos.count*3);
for(let i=0;i<tPos.count;i++)tPos.setY(i,terrainHeight(tPos.getX(i),tPos.getZ(i)));
tGeo.computeVertexNormals();
const terrain=new THREE.Mesh(tGeo,new THREE.MeshStandardMaterial({vertexColors:true,roughness:.92,metalness:.02}));scene.add(terrain);

/* ====== ROADS ====== */
const roadMat=new THREE.MeshStandardMaterial({color:"#5a6050",roughness:.92}),lineMat=new THREE.MeshBasicMaterial({color:"#e8d89c"});
function addRoad(cx,cz,w,d){const m=new THREE.Mesh(new THREE.PlaneGeometry(w,d),roadMat);m.rotation.x=-Math.PI/2;m.position.set(cx,ROAD_Y+.02,cz);scene.add(m);
const hz=w>d,len=hz?w:d;for(let i=-len/2+3;i<len/2;i+=6){const mk=new THREE.Mesh(new THREE.PlaneGeometry(1.6,.22),lineMat);mk.rotation.x=-Math.PI/2;
if(hz)mk.position.set(cx-len/2+i+3,ROAD_Y+.04,cz);else{mk.rotation.z=Math.PI/2;mk.position.set(cx,ROAD_Y+.04,cz-len/2+i+3);}scene.add(mk);}}
addRoad(0,3.5,16,143);addRoad(0,0,176,16);addRoad(0,-40,110,12);addRoad(0,50,96,12);
addRoad(-50,0,10,44);addRoad(50,0,10,44);addRoad(-38,5,8,90);addRoad(38,5,8,90);

/* ====== GRASS ====== */
const GRASS_N=26000;
const bVerts=new Float32Array([-.04,0,0,.04,0,0,-.025,.45,0,.025,.45,0,0,1,0]);
const bGeo2=new THREE.BufferGeometry();bGeo2.setAttribute("position",new THREE.BufferAttribute(bVerts,3));bGeo2.setIndex([0,1,2,2,1,3,2,3,4]);
const grassGeo=new THREE.InstancedBufferGeometry();grassGeo.index=bGeo2.index;grassGeo.setAttribute("position",bGeo2.getAttribute("position"));
const gO=new Float32Array(GRASS_N*3),gS=new Float32Array(GRASS_N),gA2=new Float32Array(GRASS_N);
let gi=0;while(gi<GRASS_N){const x=(Math.random()-.5)*320,z=(Math.random()-.5)*300;if(roadDist(x,z)<2||z<-48)continue;const y=terrainHeight(x,z);if(y<-.4)continue;gO[gi*3]=x;gO[gi*3+1]=y;gO[gi*3+2]=z;gS[gi]=.35+Math.random()*.9;gA2[gi]=Math.random()*Math.PI;gi++;}
grassGeo.setAttribute("aO",new THREE.InstancedBufferAttribute(gO,3));grassGeo.setAttribute("aS",new THREE.InstancedBufferAttribute(gS,1));grassGeo.setAttribute("aA",new THREE.InstancedBufferAttribute(gA2,1));
const grassMat=new THREE.ShaderMaterial({uniforms:{uTime:{value:0},uBase:{value:new THREE.Color("#3d8a2e")},uTip:{value:new THREE.Color("#a8d44e")},fogColor:{value:scene.fog.color},fogNear:{value:70},fogFar:{value:240}},
vertexShader:`attribute vec3 aO;attribute float aS,aA;uniform float uTime;varying float vH,vFD;void main(){vH=position.y;float c=cos(aA),s=sin(aA);vec3 p=vec3(position.x*c-position.z*s,position.y*aS,position.x*s+position.z*c);float ph=uTime*1.8+aO.x*.12+aO.z*.1;p.x+=position.y*position.y*.25*sin(ph);p.z+=position.y*position.y*.12*cos(ph*.7+1.3);vec4 mv=modelViewMatrix*vec4(p+aO,1.);vFD=-mv.z;gl_Position=projectionMatrix*mv;}`,
fragmentShader:`uniform vec3 uBase,uTip,fogColor;uniform float fogNear,fogFar;varying float vH,vFD;void main(){vec3 col=mix(uBase,uTip,vH)*(.75+vH*.25);float ff=smoothstep(fogNear,fogFar,vFD);col=mix(col,fogColor,ff);gl_FragColor=vec4(col,1.);}`,side:THREE.DoubleSide});
scene.add(new THREE.Mesh(grassGeo,grassMat));

/* ====== TREES — pine + deciduous ====== */
const PINE_N=250,DECI_N=200;const dm=new THREE.Object3D();
const trunkIM=new THREE.InstancedMesh(new THREE.CylinderGeometry(.14,.24,2.6,8),botw("#7d5a38","#3a2818"),PINE_N);
const c1IM=new THREE.InstancedMesh(new THREE.ConeGeometry(1.6,2.6,7),botw("#3a8a3a","#1a4a1a"),PINE_N);
const c2IM=new THREE.InstancedMesh(new THREE.ConeGeometry(1.2,2.2,7),botw("#48984a","#1a541a"),PINE_N);
const c3IM=new THREE.InstancedMesh(new THREE.ConeGeometry(.85,1.8,7),botw("#58aa48","#285a18"),PINE_N);
scene.add(trunkIM,c1IM,c2IM,c3IM);
let tp=0;while(tp<PINE_N){const x=(Math.random()-.5)*320,z=(Math.random()-.5)*300;if(roadDist(x,z)<6||z<-50)continue;const y=terrainHeight(x,z);if(y<-.3)continue;const s=.7+Math.random();dm.position.set(x,y+1.2,z);dm.scale.set(1,s,1);dm.updateMatrix();trunkIM.setMatrixAt(tp,dm.matrix);dm.position.y=y+2.4*s;dm.scale.setScalar(s);dm.updateMatrix();c1IM.setMatrixAt(tp,dm.matrix);dm.position.y=y+3.4*s;dm.scale.setScalar(s*.88);dm.updateMatrix();c2IM.setMatrixAt(tp,dm.matrix);dm.position.y=y+4.2*s;dm.scale.setScalar(s*.72);dm.updateMatrix();c3IM.setMatrixAt(tp,dm.matrix);tp++;}
[trunkIM,c1IM,c2IM,c3IM].forEach(m=>m.instanceMatrix.needsUpdate=true);
// Round deciduous trees
const dTrunkIM=new THREE.InstancedMesh(new THREE.CylinderGeometry(.18,.28,3,8),botw("#7d5a38","#3a2818"),DECI_N);
const dCanopyIM=new THREE.InstancedMesh(new THREE.IcosahedronGeometry(2,2),botw("#4aa040","#1a5a1a"),DECI_N);
scene.add(dTrunkIM,dCanopyIM);
let dp=0;while(dp<DECI_N){const x=(Math.random()-.5)*280,z=(Math.random()-.5)*260;if(roadDist(x,z)<6||z<-46)continue;const y=terrainHeight(x,z);if(y<-.2)continue;const s=.6+Math.random()*.7;dm.position.set(x,y+1.4,z);dm.scale.set(1,s,1);dm.updateMatrix();dTrunkIM.setMatrixAt(dp,dm.matrix);dm.position.y=y+3.2*s;dm.scale.set(s*.9,s*.7,s*.9);dm.updateMatrix();dCanopyIM.setMatrixAt(dp,dm.matrix);dp++;}
dm.scale.set(1,1,1);[dTrunkIM,dCanopyIM].forEach(m=>m.instanceMatrix.needsUpdate=true);

/* ====== SCATTER ====== */
const flowerIM=new THREE.InstancedMesh(new THREE.SphereGeometry(.14,6,6),botw("#e0e0e0","#606060"),500);
const rockIM=new THREE.InstancedMesh(new THREE.DodecahedronGeometry(.35,0),botw("#888890","#404048"),200);
const bushIM=new THREE.InstancedMesh(new THREE.IcosahedronGeometry(.55,1),botw("#4a9a3a","#1a4a1a"),300);
scene.add(flowerIM,rockIM,bushIM);
let fi=0;while(fi<500){const x=(Math.random()-.5)*260,z=(Math.random()-.5)*260;if(roadDist(x,z)<2||z<-46)continue;const y=terrainHeight(x,z);if(y<-.2)continue;dm.position.set(x,y+.12,z);dm.scale.setScalar(.5+Math.random()*.8);dm.rotation.set(0,0,0);dm.updateMatrix();flowerIM.setMatrixAt(fi,dm.matrix);flowerIM.setColorAt(fi,new THREE.Color().setHSL(Math.random()*.15+.85,.7,.65));fi++;}
let ri=0;while(ri<200){const x=(Math.random()-.5)*300,z=(Math.random()-.5)*300;if(roadDist(x,z)<4)continue;const y=terrainHeight(x,z);dm.position.set(x,y+.1,z);dm.scale.set(.5+Math.random(),.4+Math.random()*.6,.5+Math.random());dm.rotation.set(Math.random(),Math.random(),0);dm.updateMatrix();rockIM.setMatrixAt(ri,dm.matrix);ri++;}
let bi=0;while(bi<300){const x=(Math.random()-.5)*280,z=(Math.random()-.5)*260;if(roadDist(x,z)<4||z<-46)continue;const y=terrainHeight(x,z);if(y<-.2)continue;dm.position.set(x,y+.3,z);dm.scale.setScalar(.4+Math.random()*.7);dm.rotation.set(0,0,0);dm.updateMatrix();bushIM.setMatrixAt(bi,dm.matrix);bi++;}
dm.rotation.set(0,0,0);[flowerIM,rockIM,bushIM].forEach(m=>{m.instanceMatrix.needsUpdate=true;if(m.instanceColor)m.instanceColor.needsUpdate=true;});

/* ====== WATER ====== */
const water=new THREE.Mesh(new THREE.PlaneGeometry(260,80,50,25),waterMat);water.rotation.x=-Math.PI/2;water.position.set(0,-1,-78);scene.add(water);

/* ====== COLLISION ====== */
const staticCol=[];const dynCol=[];
function addStatic(mesh,pad){const b=new THREE.Box3().setFromObject(mesh);b.expandByScalar(pad||.2);staticCol.push(b);}
function addDynamic(mesh){dynCol.push({mesh,vel:new THREE.Vector3()});}

/* ====== TOWN CENTER — Times Square ====== */
function mkTSBuilding(x,z,w,h,d,rotY,screenText,screenColor){
    const g=new THREE.Group();
    const body=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),botw("#4a4a58","#2a2a30"));body.position.y=h/2;g.add(body);
    // Windows grid
    const winMat=new THREE.MeshBasicMaterial({color:"#a0c8e0"});
    for(let fy=3;fy<h-1;fy+=2.5)for(let fx=-(w/2-1);fx<w/2;fx+=1.8){g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.9,1.4),winMat);m.position.set(fx,fy,d/2+.01);return m;})());g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.9,1.4),winMat);m.position.set(fx,fy,-d/2-.01);m.rotation.y=Math.PI;return m;})());}
    // Decorative screen
    const cv=document.createElement("canvas");cv.width=512;cv.height=256;const ct=cv.getContext("2d");
    ct.fillStyle="#0a0a14";ct.fillRect(0,0,512,256);ct.fillStyle=screenColor;ct.font="bold 32px Segoe UI";ct.textAlign="center";ct.fillText(screenText,256,100);
    ct.fillStyle="rgba(255,255,255,.3)";ct.font="18px Segoe UI";ct.fillText("DRIVE TO DISCOVER",256,160);
    for(let y=0;y<256;y+=3)ct.fillRect(0,y,512,1);ct.strokeStyle=screenColor;ct.lineWidth=4;ct.strokeRect(2,2,508,252);
    const tex=new THREE.CanvasTexture(cv);tex.colorSpace=THREE.SRGBColorSpace;
    const scr=new THREE.Mesh(new THREE.PlaneGeometry(w*.8,h*.3),new THREE.MeshStandardMaterial({map:tex,emissive:"#fff",emissiveMap:tex,emissiveIntensity:.5}));
    scr.position.set(0,h*.65,d/2+.03);g.add(scr);
    // Neon frame
    const nm=new THREE.MeshBasicMaterial({color:screenColor});
    const sw=w*.8,sh=h*.3,sy=h*.65;
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(sw+.3,.15,.15),nm);m.position.set(0,sy+sh/2+.1,d/2+.08);return m;})());
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(sw+.3,.15,.15),nm);m.position.set(0,sy-sh/2-.1,d/2+.08);return m;})());
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.15,sh+.3,.15),nm);m.position.set(-sw/2-.1,sy,d/2+.08);return m;})());
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.15,sh+.3,.15),nm);m.position.set(sw/2+.1,sy,d/2+.08);return m;})());
    g.position.set(x,terrainHeight(x,z),z);g.rotation.y=rotY||0;scene.add(g);addStatic(g,.3);return g;
}
mkTSBuilding(-16,-16, 8,16,7, Math.PI/6,"M A T  H A R V E Y","#00ff88");
mkTSBuilding(16,-16, 7,18,6, -Math.PI/6,"4 5  P R O J E C T S","#ff6688");
mkTSBuilding(-16,16, 7,14,7, -Math.PI/6,"P O R T F O L I O  2 0 2 6","#66aaff");
mkTSBuilding(16,16, 8,15,6, Math.PI/6,"D R I V E  ·  E X P L O R E","#ffcc44");
// Fountain — small collider only
const fountain=new THREE.Group();
fountain.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(3.5,4,1,24),botw("#8899aa","#445566"));m.position.y=.5;return m;})());
fountain.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(.55,.7,3.6,12),botw("#b0b8c0","#505860"));m.position.y=2.3;return m;})());
fountain.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(1.1,.5,.6,12),botw("#a0a8b0","#505860"));m.position.y=4.4;return m;})());
fountain.add((()=>{const m=new THREE.Mesh(new THREE.SphereGeometry(.4,12,12),new THREE.MeshBasicMaterial({color:"#88ddff"}));m.position.y=4.8;return m;})());
fountain.position.set(0,ROAD_Y,0);scene.add(fountain);
// Only a small sphere collider for fountain
staticCol.push(new THREE.Box3(new THREE.Vector3(-2,-.5,-2),new THREE.Vector3(2,6,2)));
// District signs — dynamic (breakable)
function mkSign(x,z,text,color){const g=new THREE.Group();g.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,2.5,8),botw("#5a4a30","#2a2010"));m.position.y=1.25;return m;})());const cv=document.createElement("canvas");cv.width=256;cv.height=64;const ct=cv.getContext("2d");ct.fillStyle=color;ct.fillRect(0,0,256,64);ct.fillStyle="#fff";ct.font="bold 26px Segoe UI";ct.textAlign="center";ct.fillText(text,128,42);const tex=new THREE.CanvasTexture(cv);tex.colorSpace=THREE.SRGBColorSpace;g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(1.8,.45),new THREE.MeshStandardMaterial({map:tex,emissive:color,emissiveIntensity:.15}));m.position.y=2.6;return m;})());g.position.set(x,Math.max(terrainHeight(x,z),ROAD_Y),z);scene.add(g);addDynamic(g);return g;}
mkSign(5,-25,"PORT DISTRICT","#2a6a66");mkSign(-5,26,"CREATIVE VILLAGE","#8a4060");
mkSign(24,5,"SCIENCE PARK","#3a4080");mkSign(-24,5,"TECH HUB","#8a6a20");
// Lamp posts — NO collision, just decorative
function mkLamp(x,z){const g=new THREE.Group();g.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(.06,.1,4.2,8),botw("#383840","#1a1a20"));m.position.y=2.1;return m;})());g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.06,.06,.8),botw("#383840","#1a1a20"));m.position.set(0,3.9,.35);return m;})());g.add((()=>{const m=new THREE.Mesh(new THREE.SphereGeometry(.22,8,8),new THREE.MeshBasicMaterial({color:"#ffe8a0"}));m.position.set(0,3.6,.65);return m;})());g.position.set(x,Math.max(terrainHeight(x,z),ROAD_Y),z);scene.add(g);return g;}
[[11,11],[-11,11],[11,-11],[-11,-11],[14,0],[-14,0],[0,14],[0,-14]].forEach(([x,z])=>mkLamp(x,z));
// Benches — dynamic (breakable)
function mkBench(x,z,r){const g=new THREE.Group();g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(1.6,.08,.5),botw("#a08060","#504020"));m.position.y=.5;return m;})());g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(1.6,.5,.06),botw("#907050","#483828"));m.position.set(0,.75,-.2);return m;})());g.position.set(x,Math.max(terrainHeight(x,z),ROAD_Y),z);g.rotation.y=r||0;scene.add(g);addDynamic(g);return g;}
[[-8,6,0],[8,6,Math.PI],[-8,-6,0],[8,-6,Math.PI]].forEach(([x,z,r])=>mkBench(x,z,r));

/* ====== PORT ====== */
const dock=new THREE.Mesh(new THREE.BoxGeometry(120,.6,20),botw("#7d5a38","#3a2818"));dock.position.set(0,-.1,-55);scene.add(dock);addStatic(dock);
for(let x=-55;x<=55;x+=8){const p=new THREE.Mesh(new THREE.CylinderGeometry(.22,.3,3.5,8),botw("#6a4a28","#301a08"));p.position.set(x,-1.5,-64);scene.add(p);}
const lh=new THREE.Group();lh.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(1.2,1.7,14,12),botw("#e0dcd0","#808078"));m.position.y=7;return m;})());lh.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(1.4,1.4,2.5,12),botw("#cc2830","#601010"));m.position.y=9;return m;})());lh.add((()=>{const m=new THREE.Mesh(new THREE.SphereGeometry(.5,12,12),new THREE.MeshBasicMaterial({color:"#ffee60"}));m.position.y=16;return m;})());lh.position.set(-62,terrainHeight(-62,-55),-55);scene.add(lh);addStatic(lh,.5);
const contC=["#c44030","#3060a0","#d08030","#309050","#a040a0","#c0a030"];
for(let i=0;i<12;i++){const c=new THREE.Mesh(new THREE.BoxGeometry(3.2,2,2),botw(contC[i%6]));c.position.set(48+(i%4)*4,.8,-55-Math.floor(i/4)*2.6);c.rotation.y=.08*(i%3);scene.add(c);addStatic(c);}
// Dynamic crates and barrels — these fly when hit
const crateMat=botw("#8a7048","#4a3820"),barrelMat=botw("#6a5838","#3a2818");
[[-40,-52],[-37,-53],[-34,-51],[52,-48],[55,-49],[57,-47],[-42,-48],[-30,-50],[45,-52],[50,-46]].forEach(([x,z])=>{const cr=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),crateMat);cr.position.set(x,.3+Math.max(terrainHeight(x,z),ROAD_Y),z);cr.rotation.y=Math.random()*.5;scene.add(cr);addDynamic(cr);});
[[-38,-54],[54,-50],[58,-48],[-32,-52],[48,-47]].forEach(([x,z])=>{const br=new THREE.Mesh(new THREE.CylinderGeometry(.45,.45,1.1,10),barrelMat);br.position.set(x,.35+Math.max(terrainHeight(x,z),ROAD_Y),z);scene.add(br);addDynamic(br);});
// Crane
const crane=new THREE.Group();crane.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.8,16,.8),botw("#d08030","#704010"));m.position.y=8;return m;})());crane.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(12,.6,.6),botw("#d08030","#704010"));m.position.set(4,15.5,0);return m;})());crane.position.set(62,terrainHeight(62,-55),-55);scene.add(crane);addStatic(crane,.3);

/* ====== SCIENCE PARK ====== */
function mkModern(x,z,h,w,d,color){const g=new THREE.Group();g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),botw(color));m.position.y=h/2;return m;})());
const wm=new THREE.MeshBasicMaterial({color:"#88b8dd",transparent:true,opacity:.6});
for(let fy=2;fy<h-1;fy+=2.2)for(let fx=-(w/2-.8);fx<w/2;fx+=1.6){g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.9,1.3),wm);m.position.set(fx,fy,d/2+.01);return m;})());g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.9,1.3),wm);m.position.set(fx,fy,-d/2-.01);m.rotation.y=Math.PI;return m;})());}
g.position.set(x,terrainHeight(x,z),z);scene.add(g);addStatic(g,.3);return g;}
mkModern(52,16,10,5,4,"#9098b0");mkModern(66,-14,8,4,4,"#8090a8");mkModern(72,14,12,5,4,"#a0a8c0");mkModern(48,-16,7,4,3,"#8898b0");

/* ====== TECH HUB ====== */
function mkWarehouse(x,z,w,d,color){const g=new THREE.Group();g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(w,5,d),botw(color));m.position.y=2.5;return m;})());
g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(w*.35,3,.1),new THREE.MeshBasicMaterial({color:"#88aacc",transparent:true,opacity:.5}));m.position.set(0,2.5,d/2+.05);return m;})());
g.position.set(x,terrainHeight(x,z),z);scene.add(g);addStatic(g,.3);return g;}
mkWarehouse(-62,16,8,6,"#a09888");mkWarehouse(-75,-12,6,5,"#90a090");mkWarehouse(-72,14,7,5,"#a0a898");mkWarehouse(-48,-14,7,5,"#988880");

/* ====== CREATIVE VILLAGE ====== */
function mkHouse(x,z,wallColor,sc){const g=new THREE.Group(),s=sc||1;
g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(3.8*s,3*s,3.2*s),botw(wallColor));m.position.y=1.5*s;return m;})());
g.add((()=>{const m=new THREE.Mesh(new THREE.ConeGeometry(3.2*s,2*s,4),botw("#8a5030","#4a2818"));m.position.y=4*s;m.rotation.y=Math.PI/4;return m;})());
g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.7*s,1.3*s,.1),botw("#5a3a20","#2a1a08"));m.position.set(0,.65*s,1.61*s);return m;})());
g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.4*s,1.2*s,.4*s),botw("#707078","#383840"));m.position.set(.8*s,4.6*s,-.5*s);return m;})());
for(const wx of[-.8,.8])for(const wy of[1.5,2.3])g.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.4*s,.45*s),new THREE.MeshBasicMaterial({color:"#d8e0ff"}));m.position.set(wx*s,wy*s,1.61*s);return m;})());
g.position.set(x,terrainHeight(x,z),z);scene.add(g);addStatic(g,.2);return g;}
const hCols=["#e8d8c0","#f0e8e0","#d0e0d0","#e0d0c0","#e8e0d8","#d8e0d8","#e0e0d0","#d8d0c0"];
[[-35,36],[-20,36],[-5,36],[10,36],[25,36],[40,36],[-28,64],[-12,64],[4,64],[20,64],[36,64]].forEach(([x,z],i)=>mkHouse(x,z,hCols[i%hCols.length],.85+Math.random()*.3));
// Windmill
const windmill=new THREE.Group();windmill.add((()=>{const m=new THREE.Mesh(new THREE.CylinderGeometry(.9,1.3,8,10),botw("#d8d0c0","#8a8070"));m.position.y=4;return m;})());windmill.add((()=>{const m=new THREE.Mesh(new THREE.ConeGeometry(1.3,2.2,10),botw("#8a5030","#4a2818"));m.position.y=9.1;return m;})());
const bladeGroup=new THREE.Group();for(let i=0;i<4;i++){const bl=new THREE.Mesh(new THREE.BoxGeometry(.3,3.5,.05),botw("#d0c8b0","#706850"));bl.position.set(0,1.75,0);const pv=new THREE.Group();pv.add(bl);pv.rotation.z=i*Math.PI/2;bladeGroup.add(pv);}
bladeGroup.position.set(0,8,1.2);windmill.add(bladeGroup);windmill.position.set(42,terrainHeight(42,72),72);scene.add(windmill);addStatic(windmill,.5);
// Dynamic garden props in village
[[- 24,40],[0,40],[24,40],[-16,58],[8,58],[32,58]].forEach(([x,z])=>{const cr=new THREE.Mesh(new THREE.BoxGeometry(.8,.8,.8),botw("#7a6040","#3a2818"));cr.position.set(x,.2+Math.max(terrainHeight(x,z),ROAD_Y),z);scene.add(cr);addDynamic(cr);});

/* ====== MOUNTAINS ====== */
const mtMats=[botw("#707078","#383840"),botw("#7a7a82","#404048"),botw("#686870","#303038")];
for(let i=0;i<30;i++){const a=(i/30)*Math.PI*2,r=150+Math.random()*35;const mt=new THREE.Mesh(new THREE.ConeGeometry(14+Math.random()*12,26+Math.random()*20,6),mtMats[i%3]);mt.position.set(Math.cos(a)*r,6,Math.sin(a)*r);mt.rotation.y=Math.random()*Math.PI;scene.add(mt);}

/* ====== GIF BILLBOARDS + PARKING BAYS ====== */
const interactables=[],billboards=[];
const gifHost=document.createElement("div");gifHost.style.cssText="position:absolute;top:-9999px;left:-9999px;width:1px;height:1px;overflow:hidden;";document.body.appendChild(gifHost);
const pCv=document.createElement("canvas");pCv.width=64;pCv.height=64;const pCtx=pCv.getContext("2d");pCtx.fillStyle="#e8d060";pCtx.font="bold 48px sans-serif";pCtx.textAlign="center";pCtx.fillText("P",32,48);const pTex=new THREE.CanvasTexture(pCv);
const bayMat=new THREE.MeshBasicMaterial({color:"#e8d060"});const frameMat=botw("#1a1a20","#0a0a10");
const gifData=ALL_PROJECTS.map(pr=>{const img=new Image();img.src=`gifs/${pr.g}`;gifHost.appendChild(img);
const cv=document.createElement("canvas");cv.width=512;cv.height=256;const ctx=cv.getContext("2d");ctx.fillStyle="#0a0a12";ctx.fillRect(0,0,512,256);ctx.fillStyle="#888";ctx.font="24px Segoe UI";ctx.fillText("Loading…",200,135);
const tex=new THREE.CanvasTexture(cv);tex.colorSpace=THREE.SRGBColorSpace;const d={img,cv,ctx,tex,title:pr.t,district:pr.district,loaded:false};img.onload=()=>{d.loaded=true;};return d;});

ALL_PROJECTS.forEach((pr,idx)=>{
    const g=new THREE.Group();const y=Math.max(terrainHeight(pr.wx,pr.wz),ROAD_Y)+.1;
    g.position.set(pr.wx,y,pr.wz);
    // Posts
    const pm=botw("#707078","#383840");
    const pl=new THREE.Mesh(new THREE.CylinderGeometry(.1,.14,5,8),pm);const pr2=pl.clone();
    pl.position.set(-1.8,2.5,0);pr2.position.set(1.8,2.5,0);g.add(pl,pr2);
    // Frame
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(5,2.2,.14),frameMat);m.position.y=4;return m;})());
    // Screen
    const bm=new THREE.MeshStandardMaterial({map:gifData[idx].tex,roughness:.3,metalness:.05,emissive:"#fff",emissiveMap:gifData[idx].tex,emissiveIntensity:.35});
    const bd=new THREE.Mesh(new THREE.BoxGeometry(4.8,2,.2),bm);bd.position.set(0,4,.02);bd.userData.project=pr;g.add(bd);
    // Click target
    const tr=new THREE.Mesh(new THREE.PlaneGeometry(5.2,2.3),new THREE.MeshBasicMaterial({transparent:true,opacity:0,depthWrite:false}));
    tr.position.set(0,4,.25);tr.userData.project=pr;g.add(tr);
    // Neon accent bars (Times Square feel on all billboards)
    const nc=DISTRICTS[pr.district].color;const nm=new THREE.MeshBasicMaterial({color:nc});
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(5.2,.12,.12),nm);m.position.set(0,5.05,.05);return m;})());
    g.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(5.2,.12,.12),nm);m.position.set(0,2.95,.05);return m;})());
    // Parking bay (local +z = in front of screen)
    const bay=new THREE.Group();
    bay.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.14,4),bayMat);m.rotation.x=-Math.PI/2;m.position.set(-1.6,.03,3);return m;})());
    bay.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.14,4),bayMat);m.rotation.x=-Math.PI/2;m.position.set(1.6,.03,3);return m;})());
    bay.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(3.2,.14),bayMat);m.rotation.x=-Math.PI/2;m.position.set(0,.03,1);return m;})());
    bay.add((()=>{const m=new THREE.Mesh(new THREE.PlaneGeometry(.8,.8),new THREE.MeshBasicMaterial({map:pTex,transparent:true}));m.rotation.x=-Math.PI/2;m.position.set(0,.04,3);return m;})());
    g.add(bay);
    // Rotation: use direct rotation.y (no lookAt) — guaranteed correct
    g.rotation.y=bbRot(pr);
    scene.add(g);interactables.push(bd,tr);
    // Compute bay world position from rotation
    const bayLocal=new THREE.Vector3(0,0,3);
    bayLocal.applyAxisAngle(new THREE.Vector3(0,1,0),g.rotation.y);
    const bayPos=g.position.clone().add(bayLocal);
    billboards.push({group:g,project:pr,boardMat:bm,bayPos,gifIdx:idx});
});

/* ====== COLLECTIBLES ====== */
const orbs=[];
for(let i=0;i<15;i++){let ox,oz;do{ox=(Math.random()-.5)*260;oz=(Math.random()-.5)*260;}while(roadDist(ox,oz)<3||oz<-48);const oy=terrainHeight(ox,oz);if(oy<-.3){i--;continue;}const o=new THREE.Mesh(new THREE.IcosahedronGeometry(.5,1),new THREE.MeshStandardMaterial({color:"#60ffc0",emissive:"#1a6a50",emissiveIntensity:1.2}));o.position.set(ox,oy+1.8,oz);o.userData.id=`o${i}`;scene.add(o);orbs.push(o);}
const arrow=new THREE.Mesh(new THREE.ConeGeometry(.45,1.4,6),new THREE.MeshStandardMaterial({color:"#60ffc0",emissive:"#1a5a40",emissiveIntensity:1.2}));arrow.rotation.x=-Math.PI/2;scene.add(arrow);

/* ====== CAR ====== */
function createCar(){const w=new THREE.Group(),body=new THREE.Group();const p=new THREE.MeshMatcapMaterial({matcap:MC.red}),tr=new THREE.MeshMatcapMaterial({matcap:MC.dark}),gl=new THREE.MeshMatcapMaterial({matcap:MC.glass});
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(3.6,.55,1.8),p);m.position.y=.68;return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(1.3,.18,1.76),p);m.position.set(1.05,.98,0);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(1.48,.5,1.4),gl);m.position.set(-.28,1.2,0);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(1.1,.36,1.66),p);m.position.set(-1.28,1,0);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(3.7,.1,1.92),tr);m.position.y=.42;return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.12,.14,.48),new THREE.MeshBasicMaterial({color:"#fff8e0"}));m.position.set(1.84,.87,.54);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.12,.14,.48),new THREE.MeshBasicMaterial({color:"#fff8e0"}));m.position.set(1.84,.87,-.54);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.1,.16,.38),new THREE.MeshBasicMaterial({color:"#ff5050"}));m.position.set(-1.84,.85,.5);return m;})());
body.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(.1,.16,.38),new THREE.MeshBasicMaterial({color:"#ff5050"}));m.position.set(-1.84,.85,-.5);return m;})());
const wG=new THREE.CylinderGeometry(.35,.35,.3,18),wM=new THREE.MeshMatcapMaterial({matcap:MC.dark}),wheels=[];
[[1.08,.35,.84],[1.08,.35,-.84],[-1.06,.35,.84],[-1.06,.35,-.84]].forEach(([x,y,z])=>{const wh=new THREE.Mesh(wG,wM);wh.rotation.z=Math.PI/2;wh.position.set(x,y,z);body.add(wh);wheels.push(wh);});
body.rotation.y=Math.PI/2;w.add(body);w.userData.wheels=wheels;return w;}
const car=createCar();car.position.set(0,ROAD_Y+1,5);scene.add(car);
const carShadow=new THREE.Mesh(new THREE.PlaneGeometry(3.8,2),new THREE.MeshBasicMaterial({color:"#000",transparent:true,opacity:.18,depthWrite:false}));carShadow.rotation.x=-Math.PI/2;scene.add(carShadow);

/* ====== PARTICLES ====== */
const LEAF_N=200;const leafPos=new Float32Array(LEAF_N*3),leafSizes=new Float32Array(LEAF_N);
for(let i=0;i<LEAF_N;i++){leafPos[i*3]=(Math.random()-.5)*160;leafPos[i*3+1]=3+Math.random()*25;leafPos[i*3+2]=(Math.random()-.5)*160;leafSizes[i]=1.5+Math.random()*2.5;}
const leafGeo=new THREE.BufferGeometry();leafGeo.setAttribute("position",new THREE.BufferAttribute(leafPos,3));leafGeo.setAttribute("aSize",new THREE.BufferAttribute(leafSizes,1));
const leafMat=new THREE.ShaderMaterial({uniforms:{fogColor:{value:scene.fog.color},fogNear:{value:70},fogFar:{value:240}},vertexShader:`attribute float aSize;varying float vAlpha,vFD;void main(){vAlpha=.5+.3*sin(position.x+position.z);vec4 mv=modelViewMatrix*vec4(position,1.);vFD=-mv.z;gl_PointSize=aSize*(200./max(-mv.z,1.));gl_Position=projectionMatrix*mv;}`,fragmentShader:`uniform vec3 fogColor;uniform float fogNear,fogFar;varying float vAlpha,vFD;void main(){float d=length(gl_PointCoord-.5);if(d>.45)discard;float ff=smoothstep(fogNear,fogFar,vFD);vec3 col=mix(vec3(.85,.6,.28),fogColor,ff);gl_FragColor=vec4(col,vAlpha*(1.-d*2.2));}`,transparent:true,depthWrite:false});
scene.add(new THREE.Points(leafGeo,leafMat));

/* ====== AUDIO ====== */
class AudioEngine{constructor(){this.ctx=null;this.master=null;this.initialized=false;this.muted=false;}
init(){if(this.initialized)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.master=this.ctx.createGain();this.master.gain.value=.2;this.master.connect(this.ctx.destination);this.lo=this.ctx.createOscillator();this.hi=this.ctx.createOscillator();this.lo.type="sawtooth";this.hi.type="triangle";this.lg=this.ctx.createGain();this.hg=this.ctx.createGain();this.lg.gain.value=0;this.hg.gain.value=0;this.lo.connect(this.lg).connect(this.master);this.hi.connect(this.hg).connect(this.master);this.lo.start();this.hi.start();const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*2,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;this.wind=this.ctx.createBufferSource();this.wind.buffer=buf;this.wind.loop=true;const bp=this.ctx.createBiquadFilter();bp.type="bandpass";bp.frequency.value=500;this.wg=this.ctx.createGain();this.wg.gain.value=.01;this.wind.connect(bp).connect(this.wg).connect(this.master);this.wind.start();this.initialized=true;}catch(e){}}
update(spd,thr){if(!this.initialized||this.muted)return;const n=this.ctx.currentTime,r=.2+Math.min(Math.abs(spd)/30,1);this.lo.frequency.setTargetAtTime(65+r*110,n,.03);this.hi.frequency.setTargetAtTime(120+r*240,n,.03);this.lg.gain.setTargetAtTime(.02+r*.06+thr*.02,n,.04);this.hg.gain.setTargetAtTime(.006+r*.035,n,.04);this.wg.gain.setTargetAtTime(.007+r*.02,n,.1);}
chime(f=880,d=.12){if(!this.initialized||this.muted)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type="sine";o.frequency.value=f;g.gain.value=0;o.connect(g).connect(this.master);const n=this.ctx.currentTime;g.gain.setValueAtTime(0,n);g.gain.linearRampToValueAtTime(.1,n+.015);g.gain.exponentialRampToValueAtTime(.0001,n+d);o.start(n);o.stop(n+d+.03);}
setMuted(v){this.muted=v;if(this.initialized)this.master.gain.value=v?0:.2;}}
const audio=new AudioEngine();
function toggleMute(){state.muted=!state.muted;audio.setMuted(state.muted);muteBtn.textContent=`Audio: ${state.muted?"OFF":"ON"}`;}
muteBtn.addEventListener("click",toggleMute);

/* ====== INPUT ====== */
const pressed=new Set();const KM={KeyW:"f",ArrowUp:"f",KeyS:"b",ArrowDown:"b",KeyA:"l",ArrowLeft:"l",KeyD:"r",ArrowRight:"r",ShiftLeft:"x",ShiftRight:"x"};
window.addEventListener("keydown",e=>{const k=KM[e.code];if(k){pressed.add(k);e.preventDefault();}if(e.code==="KeyE")openBB();if(e.code==="KeyM")toggleMute();if(!audio.initialized)audio.init();},{passive:false});
window.addEventListener("keyup",e=>{const k=KM[e.code];if(k){pressed.delete(k);e.preventDefault();}},{passive:false});
window.addEventListener("pointerdown",()=>{if(!audio.initialized)audio.init();});
document.addEventListener("visibilitychange",()=>{if(document.hidden)pressed.clear();});

/* ====== INTERACTION ====== */
const raycaster=new THREE.Raycaster(),pointer=new THREE.Vector2();
function openBB(){if(!state.canInteract)return;window.open(state.canInteract.u,"_blank","noopener");state.visited.add(state.canInteract.t);visitedEl.textContent=`${state.visited.size} / ${ALL_PROJECTS.length}`;unlock("first");
const portAll=DISTRICTS.maritime.projects.every(p=>state.visited.has(p.t));if(portAll)unlock("port");
const simAll=DISTRICTS.simulations.projects.every(p=>state.visited.has(p.t));if(simAll)unlock("science");
if(state.visited.size===ALL_PROJECTS.length)unlock("all");audio.chime(960,.12);}
renderer.domElement.addEventListener("pointerdown",e=>{const rc=renderer.domElement.getBoundingClientRect();pointer.x=((e.clientX-rc.left)/rc.width)*2-1;pointer.y=-((e.clientY-rc.top)/rc.height)*2+1;raycaster.setFromCamera(pointer,camera);const hit=raycaster.intersectObjects(interactables,false)[0];if(!hit)return;const p=hit.object.userData.project;if(!p||!state.canInteract||state.canInteract.t!==p.t)return;openBB();});

/* ====== SEASONS ====== */
const SP=[
    {sky:"#78b8e6",fog:"#a8d4ec",sun:"#fff0c8",hS:"#b4d8f0",hG:"#5a8040",gA:"#3d8a2e",gB:"#80c848",gBase:"#3d8a2e",gTip:"#a8d44e"},
    {sky:"#68a8e0",fog:"#90c4e4",sun:"#ffe8a0",hS:"#a0d0f0",hG:"#4a7a34",gA:"#308020",gB:"#6ab838",gBase:"#2e7a22",gTip:"#8cc040"},
    {sky:"#90a4c8",fog:"#b0b8cc",sun:"#ffd090",hS:"#c8d0e0",hG:"#7a6040",gA:"#8a7040",gB:"#b09040",gBase:"#7a6030",gTip:"#c0a048"},
    {sky:"#c0cce0",fog:"#d0d8e4",sun:"#fff4d4",hS:"#e0e8f4",hG:"#708090",gA:"#a0aab8",gB:"#c4ccd8",gBase:"#90a0a8",gTip:"#c0d0d4"},
];
function applyTerrain(p){const gA=new THREE.Color(p.gA),gB=new THREE.Color(p.gB),sand=new THREE.Color("#c8b888"),dirt=new THREE.Color("#8a7858");
for(let i=0;i<tPos.count;i++){const x=tPos.getX(i),z=tPos.getZ(i),y=tPos.getY(i);const bl=Math.min(Math.max((y+4)/12,0),1);
const c=gA.clone().lerp(gB,bl);if(z<-35)c.lerp(sand,Math.min(1,Math.max(0,(-z-35)/25))*.5);
const rd=roadDist(x,z);if(rd>0&&rd<4)c.lerp(dirt,(1-rd/4)*.35);const nv=vn(x*.3,z*.3);c.r*=.92+nv*.16;c.g*=.92+nv*.16;c.b*=.92+nv*.16;
tColors[i*3]=c.r;tColors[i*3+1]=c.g;tColors[i*3+2]=c.b;}tGeo.setAttribute("color",new THREE.BufferAttribute(tColors,3));tGeo.attributes.color.needsUpdate=true;}
function applySeason(){const p=SP[state.seasonIndex];scene.background.set(p.sky);scene.fog.color.set(p.fog);sun.color.set(p.sun);sunSphere.material.color.set(p.sun);hemi.color.set(p.hS);hemi.groundColor.set(p.hG);applyTerrain(p);grassMat.uniforms.uBase.value.set(p.gBase);grassMat.uniforms.uTip.value.set(p.gTip);}
applySeason();visitedEl.textContent=`0 / ${ALL_PROJECTS.length}`;

/* ====== TRY LOADING GLB MODELS (FindAsset skill) ====== */
const glbLoader=new GLTFLoader();
async function tryLoadModel(url){try{return(await glbLoader.loadAsync(url)).scene;}catch{return null;}}
// Attempt to load enhanced tree from Poimandres market (CC0)
tryLoadModel('https://market-assets.fra1.cdn.digitaloceanspaces.com/market-assets/models/tree-spruce/model.gltf').then(m=>{
    if(!m)return;for(let i=0;i<16;i++){const t=m.clone();const a=Math.random()*Math.PI*2,r=18+Math.random()*30;
    const x=Math.cos(a)*r,z=Math.sin(a)*r;t.position.set(x,terrainHeight(x,z),z);t.scale.setScalar(.8+Math.random()*.6);scene.add(t);}
}).catch(()=>{});

/* ====== GAME LOOP ====== */
const clock=new THREE.Clock();
setTimeout(()=>{const ld=document.getElementById("loading");ld.style.opacity="0";setTimeout(()=>ld.remove(),800);},800);
const CAR_R=1.0; // Reduced from 1.8 — much less aggressive collisions

function tick(){
    requestAnimationFrame(tick);
    try{
    const dt=Math.min(clock.getDelta(),.033),t=clock.getElapsedTime();
    const wF=pressed.has("f"),wB=pressed.has("b"),wL=pressed.has("l"),wR=pressed.has("r"),bst=pressed.has("x");
    const accel=bst?34:24,brake=38,revRate=14,drag=7,mxF=bst?45:32,mxR=-14;
    if(wF){if(state.speed<0){state.speed+=brake*dt;if(state.speed>0)state.speed=0;}else state.speed+=accel*dt;}
    if(wB){if(state.speed>.5){state.speed-=brake*dt;if(state.speed<0)state.speed=0;}else state.speed-=revRate*dt;}
    if(!wF&&!wB){if(Math.abs(state.speed)<.2)state.speed=0;else state.speed-=Math.sign(state.speed)*drag*dt;}
    state.speed=Math.max(mxR,Math.min(mxF,state.speed));
    if(Math.abs(state.speed)>.8)unlock("ignite");state.maxSpeed=Math.max(state.maxSpeed,Math.abs(state.speed));if(state.maxSpeed*4.2>120)unlock("speed");
    const si=(wL?1:0)-(wR?1:0);
    if(Math.abs(state.speed)>.3){const sn2=Math.min(Math.abs(state.speed)/mxF,1);const steer=si*(2+sn2*2.5)*dt;car.rotation.y+=steer*(state.speed<0?-.6:1);state.speed*=1-Math.min(Math.abs(steer)*2.2,.12);}
    const dir=new THREE.Vector3(-Math.sin(car.rotation.y),0,-Math.cos(car.rotation.y));
    car.position.addScaledVector(dir,state.speed*dt);
    car.position.x=THREE.MathUtils.clamp(car.position.x,-160,160);car.position.z=THREE.MathUtils.clamp(car.position.z,-68,160);
    const cp=car.position;

    // STATIC COLLISIONS — gentle push-out
    for(const box of staticCol){
        const nx=Math.max(box.min.x,Math.min(cp.x,box.max.x)),nz=Math.max(box.min.z,Math.min(cp.z,box.max.z));
        const dx=cp.x-nx,dz=cp.z-nz,dist=Math.sqrt(dx*dx+dz*dz);
        if(dist<CAR_R&&dist>.01){const push=(CAR_R-dist)/dist;cp.x+=dx*push;cp.z+=dz*push;state.speed*=.5;}
        else if(dist<.01&&cp.x>=box.min.x&&cp.x<=box.max.x&&cp.z>=box.min.z&&cp.z<=box.max.z){
            // Inside box — find best push-out axis
            const pushX=Math.min(cp.x-box.min.x,box.max.x-cp.x),pushZ=Math.min(cp.z-box.min.z,box.max.z-cp.z);
            if(pushX<pushZ)cp.x+=(cp.x-box.min.x<box.max.x-cp.x)?-pushX-CAR_R:pushX+CAR_R;
            else cp.z+=(cp.z-box.min.z<box.max.z-cp.z)?-pushZ-CAR_R:pushZ+CAR_R;
            state.speed*=.4;
        }
    }
    // DYNAMIC COLLISIONS — objects fly away
    for(const d of dynCol){const dp=d.mesh.position;const dx=dp.x-cp.x,dz=dp.z-cp.z;const dist=Math.sqrt(dx*dx+dz*dz);
        if(dist<CAR_R+.8&&Math.abs(state.speed)>.5){const imp=new THREE.Vector3(dx,.5,dz).normalize().multiplyScalar(Math.max(Math.abs(state.speed)*1.5,3));
        d.vel.add(imp);state.speed*=.92;state.crashes++;if(state.crashes>=10)unlock("crash");audio.chime(200,.08);}}
    for(const d of dynCol){if(d.vel.lengthSq()<.01)continue;d.mesh.position.addScaledVector(d.vel,dt);d.mesh.rotation.x+=d.vel.z*dt*2;d.mesh.rotation.z-=d.vel.x*dt*2;d.vel.y-=15*dt;d.vel.multiplyScalar(.96);
    const gy2=terrainHeight(d.mesh.position.x,d.mesh.position.z);if(d.mesh.position.y<gy2+.3){d.mesh.position.y=gy2+.3;d.vel.y=Math.abs(d.vel.y)*.3;d.vel.x*=.85;d.vel.z*=.85;}}

    const gy=terrainHeight(cp.x,cp.z);cp.y=Math.max(gy+1.05,THREE.MathUtils.lerp(cp.y,gy+1.05,.45));
    carShadow.position.set(cp.x,gy+.06,cp.z);
    const rv=new THREE.Vector3(dir.z,0,-dir.x);
    const hF=terrainHeight(cp.x+dir.x*1.3,cp.z+dir.z*1.3),hB=terrainHeight(cp.x-dir.x*1.3,cp.z-dir.z*1.3);
    const hL=terrainHeight(cp.x-rv.x*.7,cp.z-rv.z*.7),hR=terrainHeight(cp.x+rv.x*.7,cp.z+rv.z*.7);
    car.rotation.x=THREE.MathUtils.lerp(car.rotation.x,-Math.atan2(hF-hB,2.6)*.4,.12);
    car.rotation.z=THREE.MathUtils.lerp(car.rotation.z,Math.atan2(hR-hL,1.4)*.25,.12);
    car.userData.wheels.forEach((w,i)=>{w.rotation.x-=state.speed*dt*2;if(i<2)w.rotation.y=si*.22;});
    speedEl.textContent=`${Math.round(Math.abs(state.speed)*4.2)} km/h`;districtEl.textContent=getDistrict(cp.x,cp.z);audio.update(state.speed,wF?1:0);
    orbs.forEach(o=>{if(!o.visible)return;o.rotation.y+=.025;o.position.y+=Math.sin(t*3+o.position.x)*.004;if(cp.distanceTo(o.position)<2.2){o.visible=false;state.collectibles.add(o.userData.id);audio.chime(1100,.09);if(state.collectibles.size===orbs.length)unlock("collector");}});

    // Billboard proximity — park in bay
    let nearBB=null,nearD=Infinity;billboards.forEach(b=>{const d2=cp.distanceTo(b.bayPos);if(d2<nearD){nearD=d2;nearBB=b;}});
    if(nearD<4&&Math.abs(state.speed)<.4&&nearBB){
        state.canInteract=nearBB.project;const di=DISTRICTS[nearBB.project.district];
        promptEl.innerHTML=`<strong>${nearBB.project.t}</strong><span class="dt ${di.dtClass}">${di.label}</span><br>Click billboard or press E`;
        promptEl.classList.add("show");renderer.domElement.style.cursor="pointer";
    }else{state.canInteract=null;promptEl.classList.remove("show");renderer.domElement.style.cursor="default";}
    const und=billboards.find(b=>!state.visited.has(b.project.t));
    if(und){arrow.visible=true;arrow.position.set(cp.x,cp.y+2.2+Math.sin(t*5)*.12,cp.z);const adx=und.group.position.x-cp.x,adz=und.group.position.z-cp.z;arrow.rotation.y=Math.atan2(-adx,-adz);}else arrow.visible=false;
    const si3=Math.floor(t/50)%4;if(si3!==state.seasonIndex){state.seasonIndex=si3;applySeason();}seasonEl.textContent=["Spring","Summer","Autumn","Winter"][si3];
    const sn=Math.min(Math.abs(state.speed)/mxF,1);const camDist=14+sn*4,camH=7+sn*2;
    const dc=cp.clone().add(new THREE.Vector3(-dir.x*camDist,camH,-dir.z*camDist));
    camera.position.lerp(dc,1-Math.exp(-dt*4.5));camera.lookAt(cp.x,cp.y+1.2,cp.z);
    const so=t*.04;sun.position.set(Math.cos(so)*100,80+Math.sin(so*.6)*20,Math.sin(so)*60);sunSphere.position.copy(sun.position.clone().setLength(170));
    waterMat.uniforms.uTime.value=t;bladeGroup.rotation.z+=dt*.5;
    for(let i=0;i<LEAF_N;i++){const i3=i*3;leafPos[i3]+=(Math.sin(t*.7+i*2.3)*.2+.03)*dt*12;leafPos[i3+1]-=(.6+Math.sin(t+i)*.15)*dt*2;leafPos[i3+2]+=Math.cos(t*.5+i*1.7)*.15*dt*12;if(leafPos[i3+1]<0){leafPos[i3+1]=22+Math.random()*12;leafPos[i3]=cp.x+(Math.random()-.5)*100;leafPos[i3+2]=cp.z+(Math.random()-.5)*100;}}leafGeo.attributes.position.needsUpdate=true;
    // GIF textures — only nearby at ~12fps
    const gf=Math.floor(t*12);if(gf!==tick._lg){tick._lg=gf;billboards.forEach(b=>{const gd=gifData[b.gifIdx];if(!gd.loaded)return;const d2=cp.distanceTo(b.group.position);if(d2>55)return;const c=gd.ctx;c.drawImage(gd.img,0,0,512,256);const gr=c.createLinearGradient(0,180,0,256);gr.addColorStop(0,"rgba(0,0,0,0)");gr.addColorStop(.3,"rgba(0,0,0,.7)");gr.addColorStop(1,"rgba(0,0,0,.85)");c.fillStyle=gr;c.fillRect(0,180,512,76);const di=DISTRICTS[b.project.district];c.fillStyle=di.color;c.font="600 11px Segoe UI";c.fillText(di.label.toUpperCase(),14,210);c.fillStyle="#fff";c.font="700 18px Segoe UI";c.fillText(gd.title,14,232);c.fillStyle="rgba(255,255,255,.45)";c.font="400 10px Segoe UI";c.fillText("Park + press E",14,250);c.strokeStyle=di.color;c.lineWidth=2;c.strokeRect(1,1,510,254);gd.tex.needsUpdate=true;});}
    grassMat.uniforms.uTime.value=t;composer.render();
    }catch(e){console.error("Loop:",e);}
}
tick();
window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));composer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
